+++
title = "区块链的引擎：共识算法"
description = "关于区块链共识算法的研究"
tags = [
    "BlockChain",
    "EOS",
    "Consensus"
]
date = "2018-06-22"
categories = [
    "Development",
    "Technology",
]
thumbnail = "images/bc/consensus.png"
+++

共识算法是区块链的引擎，维系着区块链世界的正常运转。共识算法就是为了达到共同认识所涉及的算法，它主要解决多点统一意见的问题。 常见的共识算法
有PoW(工作量证明)，PoS(股权证明)，DPoS(委托要益证明)等。

<!--more-->

##  共识机制

区块链的共识机制，其实就是自治生态系统内部生产关系的演变，其演变方式和人类历史进程有诸多相似。

原始社会，人类是以部落形式构成的，没有阶级，没有剥削，没有压迫，劳动成果的分配是多劳多得，对应的是比特币的POW共识机制——工作量证明机制。

捕猎能力越强的人，能有更高的生存几率，在部落里也会拥有更多的决定权。这里对应的机制为PoW，工作量证明机制，就是工作越多，收益越大，越有决定权。

随着部落人越来越多，生产力水平的逐步提高，出现产品的剩余之后，就出现了贫富分化，原先的共识机制也被破坏，而被阶级社会所取代，而形成了最初的国家。

这时对应的共识机制就是POS，权益证明机制，拥有的资产越多，决定权就越高，国家的利益与权利集中于皇权贵族。

但POS会带来马太效应，强者越强，弱者越弱，开始有一批人觉醒产生了新的思想，并且开始反抗，革命，对应现在的资本主义国家与社会主义国家。

对应的共识机制也演变成了DPoS，委托权益证明。由人民群众投票推选出代表，代表民众实行决定权，就像西方国家议会制度，中国的人民代表大会制度。

**PoW和PoS是目前公有链最常用的共识机制，但是PoW和PoS在系统的处理能力上不足。主要体现在两个方面：一是区块速度不够快，例如比特币平均10分钟出一个区块，以太坊平均15s出一个区块；二是，每个区块的交易容量有限，例如比特币的区块大小在1M左右，大概能够包括2000笔交易。**

##  工作量证明（pow）

![](/images/bc/PoW.jpg)

工作量证明是第一个成功的去中心化区块链共识算法，被比特币和其他的一些加密货币使用。

### 什么是哈希函数？

哈希运算是密码学的重要组成部分，一般用来保护数据的完整性。给定一段消息，通过哈希函数可以将消息映射为固定长度的哈希值（比如sha256，将任意长度的消息映射为256位的哈希值）。哈希函数具有两个重要的特点：“无碰撞“和”不可逆“。

-   1. 所谓不可逆，就是当你知道x的HASH值，无法求出x；因此哈希函数在数学上是一种单向函数。
-   2. 所谓无碰撞，就是当你知道x，无法求出一个y， 使x与y的HASH值相同。简单来说就是，无法找到两个不同的消息x和y，算出相同的哈希值。（当然，因为消息的比特空间 << 所求哈希值的比特空间，因此其实这样的y是存在的，只是这样的y很难找，只是一个概率上的不可能）

### 比特币共识算法

####    1. 什么是工作量？

比特币一直被人诟病做了大量无意义的运算，耗费了巨量的电能。这里的运算就是比特币共识机制中的工作量，而这个运算就是哈希运算。具体是下面的运算：

     SHA256(SHA256(Block_Header))
     
这里的Block_Header可以简单理解为：一堆比特币交易txs + 一个随机数数nonce。在生成比特币区块的时候，我们可以认为txs是固定的，因此pow可以简化为：选取随机数nonce，然后求SHA256(SHA256(txs || nonce))，我们下面把这个计算叫做POWHash。

这个不断重复选取随机数nonce，计算POWHash的过程什么时候结束呢？在比特币中POWHash的前n位为0的时候，我们认为找到了一个有效的nonce，然后就可以生成比特币区块并广播给其他的矿工。这里的n是一个可调节的数，比特币中没生成2016个块，会重新调整n，n越大有效的POWHash越难计算，相反越容易。

####    2. 怎么证明？

pow中的证明值得是验证nonce是否有效，同样是计算SHA256(SHA256(txs || nonce))，不过这里的txs和nonce都是已知的，我们把运算结果记为POWHash2，我们只需要验证POWHash2是否满足前n为0，就可以证明这个区块是不是一个有效的比特币区块。

通过分析我们发现，如果要伪造交易（修改txs），需要重新找到一个nonce，因此对于非法修改区块，需要重新进行大量哈希运算来找到一个有效的nonce。由于每个区块都包含前一个区块的hash值，因此后面所有的区块都需要重新进行调整。因此修改比特币中的交易信息是计算上不可能的。

##  股权证明(PoS)

根据持有货币的量和时间，发放利息的一个制度，在股权证明PoS模式下，有一个名词叫币龄，每个币每天产生1币龄，比如你持有100个币，总共持有了30天，那么，此时你的币龄就为3000，这个时候，如果你发现了一个PoS区块，你的币龄就会被清空为0。你每被清空365币龄，你将会从区块中获得0.05个币的利息(假定利息可理解为年利率5%)，那么在这个案例中，利息 = 3000 * 5% / 365 = 0.41个币，这下就很有意思了，持币有利息。

## 委托权益证明(DPoS)

DPOS共识算法的出块节点（区块生产者）由持币用户投票选举出来，每个用户投票权重按用户的持币比例进行计算。一旦当选任何人都可以参与区块的生产。

EOS区块的生产按21个区块为一轮。在每轮开始的时候会选出21个区块生产者。前20个区块生产者由系统根据网络持币用户的投票数自动生成，最后一名区块生产者根据其得票数按概率生成。所选择的生产者会根据从区块时间导出的伪随机数轮流生产区块。

EOS每3秒生成一个区块，并且在给定的时间点，只有一个合法的区块生产者 。如果在预定的时间点，合法的区块生产者没有生成区块，则跳过该时间点的区块。

## 哪种共识算法好？

虽然BTC、ETH等是按照完全的去中心化来设计的，但是目前BTC和ETH的绝大部分算力被控制在少数的矿场手中。（ETH目前还是POW，ETH Casper PoS还在测试中。）从这个角度看，反而EOS的DPOS实际上更能做到去中心化（平均分配权力到21个节点）。

DPOS设计的逻辑是通过牺牲一定的去中心化来换取系统的性能。那么这点也正是DPOS被攻击最多的一点。

可能完美的去中心化只能存在于理想中。

**DPOS完美么? 当然不。但在人类进化到共产主义之前，在政治制度依旧以代议民主为核心，公司制度依旧以董事会为核心的当下，我想不出任何共识机制，能比DPOS更加先进。这种先进性，并非来源于技术，而是来源于我们人类本身。**
